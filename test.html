<script src="./javascript/ephemeris-0.1.0.js"></script>
<script src="./javascript/moment-with-locales.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="./javascript/skywatch.js"></script>
<script src=".javascript/sidereal_time.js"></script>

<p id="hra"></p>
<p id="ara"></p>
<p id="lst"></p>
<p id="v_mercury"></p>
<p id="dec"></p>
<p id="ha"></p>
<p id="alt"></p>
<p id = "testdicho"></p>
<button id="b_mercury" type=submit value="Afficher" onclick=drawCircle({x:375,y:250})></button>
<canvas id="redcircles" width="750" height="500" 
style="position: absolute; z-index: 0;"></canvas>


<script>
//fonction tirée de "Astronomical algorithms" par Jean Meeus

function localSideralTime(longitude) {//longitude en dégrés décimaux
    var datetime = new Date(Date.now()), 
        Y = datetime.getUTCFullYear(),
        M = datetime.getUTCMonth() + 1,//en javascript : janvier = 0 !
        D = datetime.getUTCDate(),
        h = datetime.getUTCHours(),
        m = datetime.getUTCMinutes(),
        s = datetime.getUTCSeconds();
        
    D += h / 24 + m / 60 / 24 + s / 3600 / 24;//pour avoir la fraction du jour sous forme décimale
   
    return sideralTimeGreewich(julianDay(D, M, Y)) + longitude;// longitude > 0 --> Est
}
   
function julianDay(D, M, Y) {
  var A, B;
    
  if(M <= 2) {
    M += 12;
    Y -= 1;
    }
    
  A = Math.trunc(Y / 100);
    
  if(Y < 1582) B = 0;//si l'année est une date dans le calendrier julien
  else B = Math.trunc(2 - A + Math.trunc(A / 4));
    
  return  Math.trunc(365.25 * (Y + 4716))
          + Math.trunc(30.6001 * (M + 1))
          + D + B - 1524.5;
}
   
function sideralTimeGreewich(julianday) {
  var T     = (julianday - 2451545.0) / 36525,
      temp  = (
              + 280.46061837
              + 360.98564736629 * (julianday - 2451545)
              + 0.000387933 * T * T
              - (T * T * T) / 38710000
              ) % 360;//opération modulo peut donner un résultat négatif...
  if(temp < 0) temp += 360;//...si c'est le cas, ajouter 360°
    
    return temp;
}

function hourAngle(lst, angleRA) {
  var HA = lst-angleRA%360;
  if(HA < 0) HA +=360;

  return HA;
}

function rightAscensionToAngle(hour,minute,second) {
  return (hour*15 + 0.25*minute + (15/360)*second);
}

function alt(ha, dec, lat) {
  return Math.asin(Math.sin(dec)*Math.sin(lat*Math.PI/180) + Math.cos(dec)*Math.cos(lat*Math.PI/180)*Math.cos(ha*Math.PI/180))*180/Math.PI;
}

const d = new Date();
		const tzoffset = d.getTimezoneOffset()/60;
		var date = {year: d.getFullYear(), month: d.getMonth()+1, day: d.getDate(), hours: d.getHours(), minutes: d.getMinutes(), seconds: d.getSeconds(	)};
		//var date = {year:2022, month:05, day:08, hours:05, minutes:34, seconds:23};
		$const.tlong = 4.5694; // longitude de l'observatoire
		$const.glat = 48.456; // latitude de l'observatoire

		$processor.init ();

		// sun, mercury, venus, moon, mars, jupiter, saturn, uranus, neptune, pluto, chiron, sirius
		var body = $moshier.body.saturn;
		$processor.calc (date, body);
		var ara = body.position.astrometricJ2000.dRA*180/Math.PI;
		var lst = localSideralTime(4.5694)%360;
    var ha = hourAngle(lst,ara);
    var altitude = alt(ha,body.position.astrometricJ2000.dDec,48.456);
		if ((0 < altitude) && (altitude < 90)) {
    	document.getElementById("v_mercury").innerHTML = "oui";
		}
		else {
			document.getElementById("v_mercury").innerHTML = "non";
		}
    document.getElementById("hra").innerHTML = body.position.astrometricJ2000.ra.hours + 'h' + body.position.astrometricJ2000.ra.minutes + 'm' + body.position.astrometricJ2000.ra.seconds + 's';
    document.getElementById("ara").innerHTML = ara;
    document.getElementById("lst").innerHTML = lst;
    document.getElementById("ha").innerHTML = ha;
    document.getElementById("alt").innerHTML = altitude;
    document.getElementById("dec").innerHTML = body.position.astrometricJ2000.dec.degree + '°' + body.position.astrometricJ2000.dec.minutes + "'";
</script>

<script>
function dichotomy(a0,b0,alt,az) {
		function f(x) {
			return (x*x - 2)
    }
		var a = a0;
		var b = b0;
		var c;

		while (Math.abs(b-a)>0.001) {
			c = (a+b)/2;
			var fa = f(a, 300, alt, az);
			var fb = f(b, 300, alt, az);
			var fc = f(c,300, alt, az);
			if (Math.sign(fc) == Math.sign(fa)) {
				a = c;
			}
			else {
				b = c;
			}
		}
  return c;
}

function drawCircle(z) {
		var c = document.getElementById("redcircles");
			var ctx = c.getContext("2d");
			ctx.beginPath();
			ctx.arc(z.x, z.y, 10, 0, 2 * Math.PI);
			ctx.strokeStyle = "red";
			ctx.stroke();
	}
document.getElementById("testdicho").innerHTML = dichotomy(0,5,null,null);
</script>